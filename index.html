<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìç GeoDocas Online (CSV)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 16px;
      background: #f5f7fa;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 1.5em;
      color: #1a5fb4;
      margin: 0;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      font-weight: bold;
      margin: 12px 0 6px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 6px 0;
    }
    input:focus { outline: 2px solid #1a5fb4; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .grid button {
      width: auto;
      background: #1a5fb4;
      color: white;
      font-weight: bold;
      border: none;
    }
    .grid button:hover { opacity: 0.9; }

    #status {
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: 500;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }
    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f1f5f9;
      font-weight: bold;
    }
    tr:last-child td { border-bottom: none; }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .actions button {
      flex: 1;
      min-width: 120px;
    }
    .btn-alt { background: #4caf50; }
    .btn-copy { background: #2196f3; }
    .btn-whatsapp { background: #25d366; color: white; }
  </style>
</head>
<body>
  <header>
    <h1>üìç GeoDocas ‚Äî CSV Offline</h1>
    <p>Registre at√© 4 pontos por doca. Tudo salvo no seu celular.</p>
  </header>

  <div class="card">
    <label for="doca">üìù Nome da Doca (ex: Doca01)</label>
    <input type="text" id="doca" placeholder="Digite aqui" autocomplete="off">

    <div class="grid">
      <button onclick="capturar(1)">üìç Ponto 1</button>
      <button onclick="capturar(2)">üìç Ponto 2</button>
      <button onclick="capturar(3)">üìç Ponto 3</button>
      <button onclick="capturar(4)">üìç Ponto 4</button>
    </div>

    <div id="status">Aguardando a√ß√£o...</div>
  </div>

  <div class="card">
    <h2>üìã Registros</h2>
    <div id="tabela-container">
      <table id="tabela">
        <thead>
          <tr>
            <th>Doca</th>
            <th>Ponto</th>
            <th>Lat</th>
            <th>Lng</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" style="text-align:center;color:#999">Nenhum registro ainda.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="actions">
      <button class="btn-alt" onclick="exportarCSV()">üì• Baixar CSV</button>
      <button class="btn-copy" onclick="copiarCSV()">üìã Copiar CSV</button>
      <button class="btn-whatsapp" onclick="enviarWhatsApp()">üì± WhatsApp</button>
    </div>
  </div>

  <script>
    const registros = JSON.parse(localStorage.getItem('geoDocasRegistros') || '[]');
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');

    function atualizarTabela() {
      if (registros.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#999">Nenhum registro ainda.</td></tr>`;
        return;
      }

      tbody.innerHTML = registros.map(r => `
        <tr>
          <td>${r.doca}</td>
          <td>${r.ponto}</td>
          <td>${r.lat}</td>
          <td>${r.lng}</td>
        </tr>
      `).join('');
    }

    function atualizarStatus(msg, tipo = '') {
      statusEl.textContent = msg;
      statusEl.className = tipo;
    }

    function salvarRegistros() {
      localStorage.setItem('geoDocasRegistros', JSON.stringify(registros));
    }

    function capturar(posicao) {
      const doca = document.getElementById('doca').value.trim();
      if (!doca) {
        atualizarStatus('‚ö†Ô∏è Informe o nome da doca.', 'warning');
        return;
      }

      atualizarStatus('üì° Obtendo localiza√ß√£o...', '');

      if (!navigator.geolocation) {
        atualizarStatus('‚ùå Geolocaliza√ß√£o n√£o suportada.', 'error');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          const ponto = `Geo ${posicao}`;

          const reg = { doca, ponto, lat, lng, ts: Date.now() };
          registros.push(reg);
          salvarRegistros();
          atualizarTabela();

          atualizarStatus(`‚úÖ ${doca} ‚Äì ${ponto} salvo!`, 'success');
        },
        (err) => {
          let msg = '‚ùå Falha ao obter localiza√ß√£o: ';
          if (err.code === 1) msg += 'Permiss√£o negada (verifique as configura√ß√µes).';
          else if (err.code === 2) msg += 'GPS indispon√≠vel.';
          else if (err.code === 3) msg += 'Tempo esgotado.';
          else msg += err.message || 'Erro desconhecido.';
          atualizarStatus(msg, 'error');
        },
        { enableHighAccuracy: true, timeout: 15000 }
      );
    }

    function gerarCSV() {
      if (registros.length === 0) return 'Nenhum dado registrado.';
      const cabecalho = ['Doca', 'Ponto', 'Latitude', 'Longitude'];
      const linhas = registros.map(r =>
        `"${r.doca}","${r.ponto}","${r.lat}","${r.lng}"`
      );
      return [cabecalho.join(','), ...linhas].join('\n');
    }

    function exportarCSV() {
      if (registros.length === 0) {
        atualizarStatus('‚ö†Ô∏è Nada para exportar.', 'warning');
        return;
      }

      const csv = gerarCSV();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `docas_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 100);
    }

    function copiarCSV() {
      const csv = gerarCSV();
      if (registros.length === 0) {
        atualizarStatus('‚ö†Ô∏è Nada para copiar.', 'warning');
        return;
      }

      navigator.clipboard.writeText(csv)
        .then(() => {
          atualizarStatus('‚úÖ CSV copiado! Cole em WhatsApp, Notes ou Sheets.', 'success');
        })
        .catch(() => {
          atualizarStatus('‚ùå N√£o foi poss√≠vel copiar. Tente baixar o CSV.', 'error');
        });
    }

    function enviarWhatsApp() {
      const csv = gerarCSV();
      if (registros.length === 0) {
        atualizarStatus('‚ö†Ô∏è Nada para enviar.', 'warning');
        return;
      }

      // Formata uma mensagem amig√°vel + CSV como texto (WhatsApp aceita)
      const mensagem = `üìç *Registros GeoDocas*\n\n\`\`\`\n${csv}\n\`\`\``;
      const url = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
      window.open(url, '_blank');
    }

    // Inicializa
    atualizarTabela();
  </script>
</body>
</html>
